{% from "records/macros.html" import record_files_display, create_export_modal with context %}
{% set show_previewer={'show':false} %}

<div class="rec_header">
  <div class="row rec_details">
    <div class="rec_title_info">
      <div class="title col-md-12">

        {# Show title + additional_title + imprint date #}
        {% if record.get('title_additional', '') %}
          {{ record.get('title_additional',{}).get('title','') }}
          <span>{{ record.get('imprint', {}).get('date', '') }}</span>
          <div class="additional_title">{{ record.get('title',{}).get('title','') }}</div>
        {% elif record.get('title',{}).get('title','') %}
          {{ record.get('title',{}).get('title','') }}
        {% endif %}
      </div>

      {# Show Authors ( > 5 : read_more show/hide ) #}
      <div class="rec_authors {% if (record['authors']|length) < 5 %} col-md-12" {% else %} id="rec_authors_rdmore" {% endif %}>
        {% if record['_first_corporate_name'] %}
          <kbd>{{ record['_first_corporate_name']['name'] }}</kbd>
        {% endif %}
        {% for auth in record['authors'] %}
          <a href="{{url_for('search', p='author:'+auth['last_name']+', '+auth['first_name'])}}">{{ auth['full_name'] }}</a>
        {% endfor %}
      </div>
    </div>


    <div class="col-md-12 ">
      {% if record.get('doi','') %}
        <div class="rec_thumb rec_doi">
          <div class="n"><div class="t">Cite as:</div>
        {{ record['_first_corporate_name']['name'] if record['_first_corporate_name']}}({{ record.get('imprint', {}).get('date', '') }}).{% if record.get('title_additional', '') %}{{ record.get('title_additional',{}).get('title','') }}{% elif record.get('title',{}).get('title','') %}{{ record.get('title',{}).get('title','') }}{% endif %}.{{ record.get('imprint', {}).get('publisher_name', '') }}.DOI:<a href="http://doi.org/{{ record.get('doi','') }}">{{ record.get('doi','') }}</a></div>
        </div>
      {% endif %}
      <div class="rec_thumb rec_parentcol">
        <a href="{{ url_for('collection/'+collection.name) }}"><div class="n"><div class="t">Parent Collection</div>{{ collection.name_ln }}</div></a>
      </div>
      {% if record.get('edition_statement','')  %}
        {% if record.get('edition_statement', '').get('statement', '') %}
          {% set pp = record.get('edition_statement', '').get('statement', '').replace('Release: ', '') %}
          <a href="{{ url_for('search.search', p=pp) }}">
            <div class="rec_thumb rec_parentcol">
              <div class="n"><div class="t">Release</div>{{ pp }}</div>
            </div>
          </a>
        {% endif %}
        {% if record.get('edition_statement', '').get('remainder', '') %}
          {% set rr = record.get('edition_statement', '').get('remainder', '').replace('Global tag: ', '') %}
          <a href="{{ url_for('search.search', p=rr) }}">
            <div class="rec_thumb rec_parentcol">
              <div class="n"><div class="t">Global tag</div>{{ rr }}</div>
            </div>
          </a>
        {% endif %}
      {% endif %}
      {% if record.get('collision_energy', '') %}
        {% set rr = record.get('collision_energy', '').replace('Collision energy: ', '') %}
        <a href="{{ url_for('search.search', p=rr) }}">
          <div class="rec_thumb rec_parentcol">
            <div class="n"><div class="t">Collision Energy</div>{{ rr }}</div>
          </div>
        </a>
      {% endif %}
      {% if record.get('accelerator_experiment','') %}
        <a href="{{ url_for('search.search', p=record.get('accelerator_experiment','').get('accelerator', '')) }}">
          <div class="rec_thumb rec_parentcol">
            <div class="n"><div class="t">Accelerator</div>{{ record.get('accelerator_experiment','').get('accelerator', '') }}</div>
          </div>
        </a>
        <a href="{{ url_for('search.search', p=record.get('accelerator_experiment','').get('experiment', '')) }}">
          <div class="rec_thumb rec_parentcol">
            <div class="n"><div class="t">Experiment</div>{{ record.get('accelerator_experiment','').get('experiment', '') }}</div>
          </div>
        </a>
      {% endif %}
    </div>
  </div>
</div>
<div class="rec_metadata rec_description">
  <div class="row">
    <div class="col-md-12">
      <div class="rec_title title">Description</div>
    </div>
    <div class="col-md-12">
      <div class="rec_desc">{{record.get('abstract',{}).get('summary','')}}</div>
    </div>
  </div>
</div>


{% for file in record['files'] if not with_preview %}
  {% if (file.get('url','')[-3:] == '.ig') and (show_previewer['show'] == false) %}
    {% do show_previewer.update({'show':true, 'first_file':file.get('full_name')}) %}
  {% endif %}
{% endfor %}

{% if show_previewer['show'] == true %}
<div class="rec_metadata rec_preview">
  <div class="row">
    <div class="col-md-12">
      <div id="previewer" class="rec_title title">Preview</div>
    </div>
    <div class="col-md-12">
      <div class="rec_preview_box">
        <iframe id="evd" width="100%" height="675" scrolling="no" src="{{ url_for('previewer.preview', recid=recid, filename=show_previewer['first_file']) }}"></iframe>
      </div>
    </div>
  </div>
</div>
{% endif %}

{% if record.get('computer_file_characteristics', '') %}
<div class="rec_metadata rec_dataset_info row">
  <div class="col-md-12">
    <div class="rec_title title">Characteristics</div>
    <div class="rec_desc">
        {% if record.get('computer_file_characteristics','')['characteristics'] %}
          <span><b>{{record.get('computer_file_characteristics','')['characteristics']}}</b>:</span>
        {% elif record.get('computer_file_characteristics','')['files'] %}
          <span>{{ record.get('computer_file_characteristics','')['files'] }}<b>{{ record.get('computer_file_characteristics','').get('text','') }}</b></span>
        {% elif record.get('computer_file_characteristics','')['events'] %}
          <span>{{record.get('computer_file_characteristics','')['events']}}<b>{{ record.get('computer_file_characteristics','').get('text','') }}</b></span>
        {% elif record.get('computer_file_characteristics','')['bytes'] %}
          <span>{{(record.get('computer_file_characteristics','')['bytes']|float)|filesizeformat}}<b>{{ record.get('computer_file_characteristics','').get('text','').replace('bytes','') }}</b></span>
        {% endif %}
        {% for i in record.get('computer_file_characteristics') %}
          {% if i['characteristics'] %}
            <span><b>{{i['characteristics']}}</b>:</span>
          {% elif i['files'] %}
            <span>{{ i['files'] }}<b>{{ i.get('text','') }}</b></span>
          {% elif i['events'] %}
            <span>{{i['events']}}<b>{{ i.get('text','') }}</b></span>
          {% elif i['bytes'] %}
            <span>{{(i['bytes']|float)|filesizeformat}}<b>{{ i.get('text','').replace('bytes','') }}</b></span>
          {% endif %}
        {% endfor %}
    </div>
  </div>
</div>
{% endif %}

{% if record.get('computer_file_type', {}) %}
  <div class="rec_metadata rec_description">
    <div class="row">
      <div class="col-md-12">
        <div class="rec_title title">Use with..</div>
      </div>
      <div class="col-md-12">
        <div class="rec_desc">
          {{record.get('computer_file_type', {}).get('note', '')}}
          {% for r in record.get('computer_file_type', {}).get('recid', '') %}
            <a href="{{url_for('.metadata', recid = r )}}">Record {{r}}</a>
            {{ ', ' if not loop.last }}
          {% endfor %}
        </div>
      </div>
    </div>
  </div>
{% endif %}
{% if record.get('system_details', {}) %}
  <div class="rec_metadata rec_description">
    <div class="row">
      <div class="col-md-12">
        <div class="rec_title title">System Details</div>
      </div>
      <div class="col-md-12">
        <div class="rec_desc">
          {{record.get('system_details', {}).get('note', '')}}
          {% if record.get('system_details', {}).get('recid', '') %}
            <a href="{{url_for('.metadata', recid = record.get('system_details', {}).get('recid', '') )}}">Record {{record.get('system_details', {}).get('recid', '')}}</a>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
{% endif %}
{% if record.get('other_relationship_entry', {}) %}
  <div class="rec_metadata rec_description">
    <div class="row">
      <div class="col-md-12">
        <div class="rec_title title">Related items</div>
      </div>
      <div class="col-md-12">
        <div class="rec_desc">
          {{record.get('other_relationship_entry', {}).get('heading', '')}}
          {% if record.get('other_relationship_entry', {}).get('recid', '') is string %}
            <a href="{{url_for('.metadata', recid = record.get('other_relationship_entry', {}).get('recid', '') )}}">Record {{record.get('other_relationship_entry', {}).get('recid', '')}}</a>
          {% else %}
            {% for r in record.get('other_relationship_entry', {}).get('recid', '') %}
              <a href="{{url_for('.metadata', recid = r )}}">Record {{r}}</a>
              {{ ', ' if not loop.last }}
            {% endfor %}
          {% endif %}
        </div>
      </div>
    </div>
  </div>
{% endif %}

{{ record_files_display(record.get('files',''), show_previewer['show']) }}

{% if record.get('url',[]) != [] %}
  <div class="rec_metadata rec_urls">
    <div class="row">
      <div class="col-md-12">
        <div class="rec_title title">URLs</div>
      </div>
      <div class="col-md-12" style="margin-top: 20px;font-size: 16px;color: #606D75;font-weight: 100;">
        <div class="row">
          {% if record.get('url').get('url','') %}
            {% if record.get('url').get('url') is not string %}
              {% for u in record.get('url').get('url') %}
              <a class="col-md-12" href="{{ u }}">{{ u }}</a>
              {% endfor %}
            {% else %}
              <a class="col-md-12" href="{{ record.get('url','').get('url','') }}">{{ record.get('url','').get('url','') }}</a>
            {% endif %}
          {% elif record.get('url').get('host_name','') %}
            {% if record.get('url').get('host_name') is not string %}
              {% for u in record.get('url').get('host_name') %}
              <a class="col-md-12" href="{{ u }}">{{ u }}</a>
              {% endfor %}
            {% else %}
              <a class="col-md-12" href="{{ record.get('url','').get('host_name','') }}">{{ record.get('url','').get('host_name','') }}</a>
            {% endif %}
          {% endif %}
        </div>
      </div>
    </div>
  </div>
{% endif %}
